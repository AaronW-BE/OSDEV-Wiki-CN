# 初学者常见错误

你之所以来到这里，是因为你有了“编写自己的操作系统”的想法。这个 Wiki 旨在为你提供帮助、指引和参考资料，助你在这一事业中前行。

然而，新手往往会犯一些常见的错误，或者对操作系统开发这一主题存在普遍的误解。这并不是坏事——许多人在你之前也犯过这些初学者错误，未来也会有更多人如此。这页面的目的是确保你在深入了解我们提供的信息之前，知道自己将要面对的是什么。

# 这不是什么

这可能看起来像是一组可以直接复制粘贴的教程，外加一个论坛供你在遇到问题时提问。但事实并非如此。 我们完全期望你能够承担自己的责任，在着手编写自己的操作系统之前，你应该已经是一个经验丰富的用户空间应用程序开发者。我们也期望你已经阅读过操作系统设计的相关资料，并研究了你所选平台的相应文档。不要指望这个 Wiki 或论坛能成为某种“我的操作系统的完整指南”，更不用说编程技能的通用指南了。

你在这里找到的，是前人留下的文档。他们通过阅读技术文档、可用的源代码、论坛帖子，以及通过反复试验的编程，了解了这些知识。其中一些内容是为了他们自己日后查阅而写的；另一些则是为了方便我们直接指向一篇 Wiki 文章，而不是反复解释同一个主题。

你在这里找到的，是可能对你有所帮助的小提示和路标。这不是通往奥兹国的完整地图。 也不应该是。

如果你还不清楚什么是堆栈或如何使用调试器，我们不会特意为你详细解释。访问这两个页面，你会发现它们主要处理与操作系统相关的细节，而不是该主题的通用介绍。这不是缺陷，这是设计使然。如果你在寻找通用的编程启蒙，你应该访问像StackOverflow这样的通用编程网站，先成为一名开发者，然后再立志成为一名操作系统开发者。

这个 Wiki 不会扩展成初学者手册，因为那不是它的目的。它旨在回答那些觉得自己已经准备好深入内核空间编程的人所提出的高级问题。

## 一个残酷的真相

“没有任何一个没有多年经验、精通多种语言和环境的资深开发者，应该考虑进行操作系统开发。在包括几年汇编语言或像 C 这样的系统语言的低级编码在内的十年编程经验，差不多是理解这一主题并从事相关工作的最低要求。”

更重要的是，随着不同“标准”、计算机和移动设备型号、外设以及设计概念的不断扩展，这一事实每年都在变得更加真实。

像 Dennis Ritchie、Richard Greenblatt、Gary Kildall 或 Steve Wozniak 这样的人编写一个简单的操作系统是一回事，他们面对的硬件相对简单，他们对硬件了如指掌，也没有任何标准规范需要遵守或旧有代码需要保持向后兼容。而如今在现代标准硬件上，情况已不再如此。此外，他们每个人都已经是经验丰富的工程师，已经从事了多年的系统编程。即使如此，他们也只是为系统奠定了基础；大部分工作是由一大群下属开发者在系统的核心——现代术语中的“内核”——完成后完成的。

这条规则也有例外，但不多；不要指望自己是那千分之一的例外。如果你觉得自己是，阅读一下Dunning-Kruger效应，然后再重新考虑一下。

顺便说一句，Linus Torvalds 也不完全是例外——他在编写 Linux 内核时是一名研究生，已经用 C 语言编码多年。虽然他远未达到那十年的经验门槛，但作为一名将爱好转为硕士论文的研究生，他有比大多数人更多的时间投入到这个项目中。无论如何，他在1991年发布到 USENET 的著名“Linux 0.0.1”版本不过是一个轮询调度器，远非一个完整的系统。达到那个阶段花了他一年的时间。明白了吗？

虽然确实这个 Wiki 的大多数贡献者起步时经验少得多，但对我们中的大多数人来说，这是一个由于缺乏经验而犯下的错误。我们这一群体的许多先驱者完全不知道即使是一个小型操作系统项目的规模和复杂性，也不知道自己将要面对的是什么。这是一个难以接受的现实，尤其是在像这个 Wiki 这样的资源广泛可用之前。我们无法强迫你从我们的错误中吸取教训，但至少我们可以传递这个警告。

现在，你不应该因此感到过于气馁；这里的重点不是说你做不到，而是说——如果你像我们大多数人刚开始时那样——你可能还暂时做不到。在开始这样一个大型项目时，耐心是一种美德。

## 有关于……的教程吗？

因为这个地方无法也不打算迎合初学者，常常有人会问：哪里有提供教程、良好解释或易于理解的阅读材料的地方？然而，它们并不存在。复杂的主题无法用轻松的文字描述，就像有些东西对猴子来说太复杂，无法正确学习一样。如果你阅读官方文档有困难，现在是练习的好时机。

事实上，目前存在的大多数教程至少在一个方面是有缺陷的，所以你最好一开始就不要相信它们。

# 范围

## 截止日期

无论是用于大学、兴趣还是商业用途，操作系统开发都需要时间。Linux 内核花了一年多非常专注的工作才变得有些用处，而 Linus Torvalds 所做的只是模仿现有且有良好文档记录的行为，以便让现有的用户空间在其上运行。此外，每一个像 Linux 这样成功的项目背后，都有数百个项目耗费了一人年或更多的工作，却从未达到能运行一个功能性外壳的程度。

因此，制定一个合理的路线图，明确你想完成的目标。不要假设在三个月内你的操作系统就会有图形界面和语音识别，因为操作系统开发完全没有任何快速应用开发（RAD）工具。实际上，它完全没有这些工具。（“void”。这是个笑话，懂了吗？）

## 最终目标定义

在启动一个项目时，你应该估算你的最终目标、目标用户、开发项目的目的等。操作系统开发也不例外。对目标有一个大致的想法会给你动力和方向，帮助你明确前进的方向。然而，当更好的想法出现时，不要固守最初的最终目标。

不幸的是，许多操作系统开发者没有估算他们的最终操作系统会是什么样子；因此，他们不知道该朝哪个方向前进，常常会问：“接下来该做什么？”

不过需要提到的是，为了估算你的最终目标，你应该了解现有操作系统的整个（技术）概念是如何运作的。

## 商业操作系统开发

不要指望开发一个很棒的操作系统会让你致富。如果历史告诉了我们什么，那就是最好的操作系统从未获得任何商业成功，而那些几乎完全缺乏设计和灵感的系统却因为聪明的商业策略、在正确的时间出现在正确的地点、以及适当的掩饰而成功。
尽管如此，尽管论坛的“工作”部分相对空虚，仍有一些单人开发的操作系统取得了一些商业成功。一个例子是[User:01000101|01000101]开发的“Drop-in Network Security”，这是一个专为深度包分析设计的操作系统。注意，它是针对特定应用的。要以这种方式营销你的操作系统，你需要像了解操作系统开发一样，甚至更深入地了解该应用，并且你需要在编码两方面都非常擅长。你的客户会期望你表现得专业。
另一种可能是将你的操作系统营销给目前使用 MS-DOS 进行过程控制的公司。这看似简单，因为你不必对最终应用负责，但你需要对客户的问题和询问表现出专业和及时的回应。他们可能需要长期支持。他们可能不喜欢你非常想实现的功能。
假设它不会有任何进展

与上述相反，有些人认为他们的操作系统不会有任何进展。因此，他们的项目代码很丑陋，没有考虑重要方面，通常依赖丑陋的临时解决方法。最糟糕的是，他们做出的决定不利于可用性和扩展性。结果，他们的假设变成了一个自我实现的预言。
事实上，尽管你的操作系统在测试机器之外运行的机会很低，但仍有许多从这个社区起步的先进操作系统项目。

## 避免无知

初学者常常问“做 X 的最简单方法是什么？”而不是“做 X 的最佳、正确的方法是什么？”这很危险，因为新手不会花时间去理解实现某事的更好方法，而是选择从教程中复制的概念上更简单的方法。实际上，简单的方法往往过于简单，最终会导致更多长期问题，因为初学者不知道更好的替代方案，也不知道何时应该切换。走艰难的路有什么不好呢？

常见的例子包括：懒得使用GCC 交叉编译器、不理解实模式、虚实模式、保护模式和长模式，从一个模式跳到另一个模式太快而没有首先了解如何收集所有关键配置并充分利用其功能（特别是在启动和初始化时通过 BIOS 检测基本功能）、依赖非标准的BIOS调用、不学习在你自己的操作系统以及 Windows 和 Linux 下编写硬件驱动程序以获得最大便利、将测试功能全局暴露、使用平面二进制文件而不是ELF、不学习可执行文件、存档文件、图形文件、文档文件和其他文件格式及压缩算法，等等。经验丰富的开发者使用更好的替代方案是有原因的，而你可能还不理解这些原因。经验丰富的开发者在某些情况下选择使用较差的方法，但那是因为他们可以仔细分析这种方法是否合适，并且他们知道什么时候不该用。作为初学者或中级开发者，你可能对这些方法和技术不够了解，无法判断较差的解决方案是否足够好。记住，如果你反对某种方法，你应该足够了解它，知道它的所有缺点（和优点）。无论如何，懒惰和无知只会导致未来的麻烦。如果有疑问，选择看似更保守的选择，而不是更简单的。

# 设计

## 图形界面设计

从零开始，你可能需要几年的时间才能达到真正涉及图形界面（GUI）相关的阶段。GUI 的外观最多是次要的，因为它们可以轻松地事后更改；真正决定 GUI 可用性的是功能，而这不是通过模拟图形表达的。

如果你的目标是创造一个更好看的外观而不是一个更好的操作系统，不如考虑实现一个 X 窗口管理器或桌面环境，而不是整个操作系统。

## 流行度

“我的操作系统会比 Windows、Mac OS 和 Linux 更受欢迎！”

这极不可能。要实现这一目标需要大量的时间、金钱和知识。并不是每个人都会下载你的操作系统，因为：

* 他们可能不知道什么是操作系统或如何安装一个
* 你的操作系统有安全风险
* 你的操作系统支持的应用程序较少
* 你的操作系统功能不完整（只有最小的命令行界面或糟糕的 GUI）

如果你能让几个人使用你的操作系统，你就已经很幸运了。今天流行的操作系统之所以流行，是因为它们在几十年前就已存在并满足了当时的需求，那时替代方案较少。

# 内存使用

“我希望我的操作系统使用不到几千字节的内存！”

抱歉，这几乎是不可能的。一个使用如此少内存的操作系统几乎无法使用。别指望有文件系统驱动、磁盘驱动、USB 驱动等。如果你想开发一个小型的东西，只做一个简单的引导加载程序，而不是一个操作系统。

另一个选择是尝试原生 Forth；它就像一个小型操作系统，集成了内核、命令解释器和汇编器，全部在一个微小的二进制文件中！内核的某些部分甚至可以编写脚本。它甚至不需要文件系统；许多 Forth 直接编辑和加载磁盘扇区。但有一个大问题：Forth 对技能要求不低。编写好的 Forth 是一个完全不同的领域，程序员需要理解它才能超越基础知识。令人惊讶的是，一些 Forth 爱好者擅长编写 Forth 解释器，但却是糟糕的 Forth 程序员。一个操作系统开发者需要成为一个不错的 Forth 程序员，才能将操作系统设计概念适配到 Forth，或者弄清楚哪些概念不需要。否则，操作系统会比需要的大得多。

编写紧凑的 Forth 代码可能需要大量时间和思考。Forth 的发明者 Charles Moore 编写了一个 CAD 程序，核心只有五行代码；这花了他大约两年的时间。

## 操作系统仿真

“我的操作系统将能够运行 Windows、Mac OS、Linux，甚至 PDP-11 的程序！！！”

很抱歉打破你的幻想，但这很可能不会实现。即使只是仿真一个系统，也需要多年的工作，尤其是像 Windows 或 Mac OS 这样的专有系统（Linux 在这四个中可能是最简单的）。Wine 自1993年以来一直在开发，并且是在用户空间编写的，但仍然有许多程序存在问题。

所以，与其专注于仿真其他系统，不如专注于你自己的系统。设计它，开发它，与它成为朋友。

## 编程语言

有些语言非常适合编写内核，有些则不那么适合。阅读关于使用除 C 之外的其他语言的页面。

# 内核映像

## 启动问题

特别是在早期阶段和使用自建引导加载程序时，启动问题通常是因为从磁盘获取的扇区太少。要么调整你从磁盘获取的扇区数量，要么让引导加载程序/第二阶段加载程序解析文件系统。

# 故障排除 / 寻求帮助

在论坛或 IRC 上寻求帮助之前，你应该采取所有可能的步骤，自己诊断问题的性质。在遇到像三重故障或“随机”异常这样的问题时，假设问题的原因是一个常见的错误。使用调试器或打印语句来定位异常发生的确切位置。使用模拟器和调试器（如 GDB 和 Bochs/QEMU）将帮助你定位难以追踪的问题。如果你在求助时提供一些关于问题的理论以及你已经采取的解决措施，人们会更容易帮助你（即使你的理论不正确，它至少能让别人了解你对问题的看法、你可能已经尝试过的策略，以及你可能遗漏的部分）。

总之，在向他人求助之前，尽可能多地自己努力解决问题。在发帖之前，问问自己：“我是否已经做了所有能做的来诊断和解决这个问题？”通常在这个过程中你会学到很多，你很可能会自己解决问题（以及未来类似的问题），而不需要他人的帮助，这是件好事。求助时，提供与你的问题相关的代码。然而，问题可能出现在其他地方，因此也要给他人一个查看你代码其他部分的方法（如果你使用像 GitHub 或 Bitbucket 这样的工具，这会稍微简单一些，但当然还有许多其他方法）。

关于论坛，请阅读论坛规则。这是必读内容，它会提高你的帖子质量，让人们更愿意帮助你。在 IRC 频道上，如果你提出了一个问题，不要指望10秒钟或甚至5分钟内得到答案。其他人也有自己的生活。如果你需要离开去做别的事，想查看是否错过了什么，有日志可供你查看。查看 IRC 主题中的链接以获取这些日志。

关于如何在求助时成为一个好的社区成员，可以参考如何提问。这是一篇很棒的文章，理想情况下，你在任何地方求助之前都应该完整阅读它（它不长，非常值得一读）。

# 推广

## 命名

命名通常是最后一个要解决的问题，尽管我们都希望为我们的酷概念取一个酷名字。由于名字的“酷感”是个人的品味问题，我们无法帮你找到它。此外，如果你将项目名称与某个特定功能绑定，可能会在未来发现没有哪个概念是完美的，你可能想改变最初认为的关键功能。没有什么比仅仅因为“想坚持一个名字”而不去进化更愚蠢的了……

关于命名有很多好信息，可以在这个帖子中找到。简单来说，将你的操作系统命名为 <名字>OS（JackOS、FredOS 等）可能看起来是个好主意，直到你有了第二个项目成员。一个好主意（来自 Solar 的建议）是选择一个代号（像 Longhorn、Chicago 等），然后在接近发布时再想一个更好的名字。

## 项目网站

许多操作系统开发新手在没有任何值得展示的内容之前就创建了项目网站。在你还不清楚项目方向、没有任何代码、截图或下载内容可以展示之前，创建一个做出宏伟未来计划的网站是没有价值的。这样的网站看起来像是死的，会给你的项目带来坏名声。在论坛（如 OSDev.org 论坛的公告板块）上宣布你的网站，或在你的签名中链接到它，而网站上只有“欢迎体验<插入炫酷项目名>”的信息，只会让人们在你项目刚开始时就失去兴趣。如果/当你最终开发出值得展示的东西时，你将面临一个已经很糟糕的名声，难以克服。

## 团队合作

初学者最大的错误在公告论坛中最为常见。通常以两种形式出现，尽管这两种形式有相当多的重叠：

## 社区项目

不要高估你的项目吸引他人的可能性。即使是更成功的项目，通常也只有一到两个人在实际编写代码。这并不是因为缺乏需求。

Brooks 定律指出，项目中的人数越多，项目完成所需的时间越长。唯一的解决方法是将项目分成多个部分，让人们分别专注于某一部分。祝你好运。

## 招募成员

要想有成功的可能性（并避免被尖锐地指出你的失败），你需要做到以下几点：

* 如果你没有一个成熟的代码库，人们不会加入，因为他们能看出你缺乏经验，并预计项目会失败。
* 如果你缺乏（详细的）设计，人们不会加入，因为他们看不出你的操作系统比他们自己的设计更有吸引力。
* 如果你的名声没有先行，特别是有经验的人会非常谨慎，不会信任并加入你。
* 如果你没有项目管理技能，少数加入的人很快会退出，因为他们一直在讨论而不是写代码。

尽管如此，仍然加入的人通常比那些为这份清单所针对的人编程水平更差。
